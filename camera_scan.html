<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Escáner QR - Estacionamiento</title>
	<style>
		body{font-family:Segoe UI, Tahoma, Arial; text-align:center; margin:18px; background:#eef9ff}
		video{width:320px; height:240px; border-radius:8px; background:#000}
		#output{margin-top:12px}
		button{padding:8px 12px; margin:6px; border-radius:6px; border:none; background:#0b7; color:#fff; cursor:pointer}
		.small{font-size:13px; color:#333}
		/* Toast notification */
		.toast {
			position: fixed;
			left: 50%;
			transform: translateX(-50%);
			bottom: 24px;
			background: rgba(34,34,34,0.95);
			color: #fff;
			padding: 10px 16px;
			border-radius: 8px;
			box-shadow: 0 6px 18px rgba(0,0,0,0.25);
			font-size: 14px;
			z-index: 9999;
			opacity: 0;
			transition: opacity .25s ease, transform .25s ease;
		}
		.toast.show { opacity: 1; transform: translateX(-50%) translateY(-6px); }
	</style>
</head>
<body>
	<h1>Escanear código QR</h1>
	<p class="small">Apunta la cámara al QR de la reserva. Al detectar el QR, el escáner guardará el comando en el almacenamiento local (localStorage) y mostrará confirmación. No se abrirá ninguna pestaña automáticamente.</p>

	<video id="video" autoplay muted playsinline></video>
	<canvas id="canvas" hidden></canvas>

	<div id="output">Estado: <span id="status">Esperando cámara...</span></div>

	<div style="margin-top:8px">
		<button id="startBtn">Iniciar cámara</button>
		<button id="stopBtn">Detener</button>
		<button id="openApp">Abrir estacionamiento</button>
	</div>

	<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
	<script>
	const video = document.getElementById('video');
	const canvas = document.getElementById('canvas');
	const ctx = canvas.getContext('2d');
	const status = document.getElementById('status');
	const startBtn = document.getElementById('startBtn');
	const stopBtn = document.getElementById('stopBtn');
	const openApp = document.getElementById('openApp');

	let stream = null;
	let scanning = false;
	let scanInterval = null;

	async function startCamera() {
		try {
			stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
			video.srcObject = stream;
			await video.play();
			status.textContent = 'Cámara activa. Escaneando...';
			scanning = true;
			canvas.width = video.videoWidth || 320;
			canvas.height = video.videoHeight || 240;
			scanInterval = setInterval(scanFrame, 300);
		} catch (e) {
			console.error(e);
			status.textContent = 'No se pudo acceder a la cámara. Revisa permisos o prueba con Firefox móvil.';
		}
	}

	function stopCamera() {
		scanning = false;
		status.textContent = 'Cámara detenida.';
		if (scanInterval) clearInterval(scanInterval);
		if (stream) {
			stream.getTracks().forEach(t => t.stop());
			stream = null;
		}
		video.srcObject = null;
	}

	function extractSpaceId(text) {
		// Intentar extraer "Espacio N" o un número
		const m = text.match(/Espacio\s*(\d+)/i);
		if (m) return Number(m[1]);
		const n = text.match(/\b(\d{1,3})\b/);
		return n ? Number(n[1]) : null;
	}

	function scanFrame() {
		if (!scanning || video.readyState !== video.HAVE_ENOUGH_DATA) return;
		canvas.width = video.videoWidth;
		canvas.height = video.videoHeight;
		ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
		const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
		const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'attemptBoth' });
		if (code) {
			status.textContent = 'QR detectado: ' + code.data;
			handleScanResult(code.data);
		}
	}

	let scanLock = false;
	function handleScanResult(data) {
		if (scanLock) return;
		scanLock = true;
		const spaceId = extractSpaceId(data);
		const cmd = { action: 'start', spaceId: spaceId, timestamp: Date.now(), qrData: data };
		try {
			// Guardar siempre el comando en localStorage para que otra pestaña local lo procese
			localStorage.setItem('parkingCommand', JSON.stringify(cmd));
			status.textContent = `QR escaneado correctamente (espacio ${spaceId}).`;
			// Mostrar notificación visual y (si es posible) notificación del sistema
			showToast(`QR escaneado correctamente (espacio ${spaceId})`);
			trySystemNotification('QR escaneado', `Espacio ${spaceId}`);
		} catch (e) {
			console.error('localStorage error', e);
			status.textContent = 'Error guardando comando en localStorage.';
		}
		// permitir otro escaneo después de 1.2s
		setTimeout(() => { scanLock = false; }, 1200);
	}

	// Mostrar un toast en pantalla
	function showToast(text, ms = 2500) {
		const t = document.createElement('div');
		t.className = 'toast';
		t.textContent = text;
		document.body.appendChild(t);
		// allow render
		requestAnimationFrame(() => t.classList.add('show'));
		setTimeout(() => { t.classList.remove('show'); setTimeout(()=>t.remove(), 300); }, ms);
	}

	// Intentar mostrar notificación del sistema (si el navegador lo permite)
	async function trySystemNotification(title, body) {
		if (!('Notification' in window)) return;
		try {
			if (Notification.permission === 'granted') {
				new Notification(title, { body });
			} else if (Notification.permission === 'default') {
				const p = await Notification.requestPermission();
				if (p === 'granted') new Notification(title, { body });
			}
		} catch (e) {
			// ignorar errores de notificación
			console.warn('System notification failed', e);
		}
	}

	startBtn.addEventListener('click', startCamera);
	stopBtn.addEventListener('click', stopCamera);
	openApp.addEventListener('click', () => window.open('Estacionamiento.html', '_blank'));

	// intentar iniciar la cámara automáticamente al abrir (puede ser bloqueado por el navegador)
	(async () => {
		try {
			// esperar un ratito para que la UI termine de cargar
			await new Promise(r => setTimeout(r, 200));
			startCamera();
		} catch (e) {
			console.warn('Auto-start cámara falló:', e);
		}
	})();
	</script>
</body>
</html>
